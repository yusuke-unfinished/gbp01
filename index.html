<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleビジネスプロフィール レポートツール</title>
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (グラフ描画用) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 印刷時のスタイル調整 */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-break-inside-avoid { break-inside: avoid; }
            .print-shadow-none { box-shadow: none !important; }
            .print-border-none { border: none !important; }
            .print-full-width { width: 100% !important; max-width: none !important; }
            /* 印刷時にグラフのサイズを確保 */
            canvas { max-height: 100% !important; }
        }
        /* ContentEditableのプレースホルダー風スタイル */
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block; /* For Firefox */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10 print:static print:shadow-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg no-print">
                    <i data-lucide="map-pin" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 id="header-business-name" class="text-xl font-bold text-gray-900">読み込み中...</h1>
                    <p class="text-xs text-gray-500">Googleビジネスプロフィール レポート</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 no-print">
                <!-- 月選択 -->
                <div class="flex items-center bg-gray-100 rounded-lg p-1 mr-4">
                    <button id="btn-prev-month" class="p-1.5 hover:bg-white rounded-md disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span id="current-month-display" class="mx-3 font-bold text-sm min-w-[80px] text-center">---</span>
                    <button id="btn-next-month" class="p-1.5 hover:bg-white rounded-md disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- タブ切り替え -->
                <div class="hidden md:flex bg-gray-100 rounded-lg p-1">
                    <button id="tab-dashboard" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center bg-white shadow text-blue-600">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> レポート
                    </button>
                    <button id="tab-edit" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center text-gray-600 hover:bg-gray-200">
                        <i data-lucide="edit-2" class="w-4 h-4 mr-1"></i> データ編集
                    </button>
                </div>
                
                <button onclick="window.print()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">印刷</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 print:py-0 print:px-0 print:w-full print-full-width">
        
        <!-- 期間表示 -->
        <div class="mb-8 print:mb-4 text-center print:text-left">
            <span id="report-period-badge" class="inline-block bg-white border border-gray-200 rounded-full px-4 py-1 text-sm text-gray-600 shadow-sm print:border-none print:shadow-none print:px-0 print:font-bold">
                対象期間: ---
            </span>
        </div>

        <!-- コンテンツエリア：ダッシュボード -->
        <div id="view-dashboard" class="space-y-8 print:space-y-6">
            
            <!-- KPI カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 print:grid-cols-4">
                <!-- KPI 1 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">総検索・閲覧数</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="search" class="w-5 h-5 text-blue-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-total-views" class="text-2xl font-bold text-gray-900">0</h3>
                    </div>
                    <div id="kpi-views-growth" class="flex items-center text-xs font-medium text-green-600">
                        <!-- JSで動的に挿入 -->
                    </div>
                    <p class="text-xs text-gray-400 mt-2">検索 + マップ表示</p>
                </div>

                <!-- KPI 2 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">総アクション数</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="mouse-pointer" class="w-5 h-5 text-green-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-total-actions" class="text-2xl font-bold text-gray-900">0</h3>
                    </div>
                    <div id="kpi-actions-growth" class="flex items-center text-xs font-medium text-red-600">
                        <!-- JSで動的に挿入 -->
                    </div>
                    <p class="text-xs text-gray-400 mt-2">ウェブ・電話・ルート</p>
                </div>

                <!-- KPI 3 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">平均評価</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="star" class="w-5 h-5 text-yellow-500"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-rating" class="text-2xl font-bold text-gray-900">0.0</h3>
                        <span class="text-yellow-500 text-lg">★</span>
                    </div>
                    <p id="kpi-review-count" class="text-xs text-gray-400 mt-2">全レビュー数: 0</p>
                </div>

                <!-- KPI 4 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">写真閲覧数</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="image" class="w-5 h-5 text-purple-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-photo-views" class="text-2xl font-bold text-gray-900">0</h3>
                    </div>
                    <div class="flex items-center text-xs font-medium text-green-600">
                        <i data-lucide="trending-up" class="w-3 h-3 mr-1"></i> 5.4% <span class="text-gray-400 ml-1 font-normal">前月比</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">オーナー投稿 + ユーザー投稿</p>
                </div>
            </div>

            <!-- チャートエリア 1: 閲覧数の推移 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                <div class="mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5 text-gray-500"></i>
                        ビジネスプロフィールの表示回数推移
                    </h2>
                    <p class="text-sm text-gray-500">検索結果とマップでの表示回数の日次推移</p>
                </div>
                <div class="relative w-full h-64">
                    <canvas id="chart-views"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 print:grid-cols-2">
                <!-- チャートエリア 2: アクション内訳 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                    <div class="mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="mouse-pointer" class="w-5 h-5 text-gray-500"></i>
                            ユーザーアクションの内訳
                        </h2>
                        <p class="text-sm text-gray-500">プロフィールを見たユーザーの行動</p>
                    </div>
                    <div class="relative w-full h-64">
                        <canvas id="chart-actions"></canvas>
                    </div>
                </div>

                <!-- チャートエリア 3: 検索キーワード (動的データ反映) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                    <div class="mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i>
                            検索クエリ (上位5件)
                        </h2>
                        <p class="text-sm text-gray-500">どのようなキーワードで検索されたか</p>
                    </div>
                    
                    <div id="keyword-list-container" class="space-y-4">
                        <!-- JSで動的にリスト生成 -->
                    </div>
                </div>
            </div>

            <!-- コメント・改善提案セクション -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-5 h-5 text-gray-500"></i>
                    今月の総括と改善提案
                </h2>
                <div 
                    id="comment-display"
                    contenteditable="true" 
                    class="w-full min-h-[100px] p-4 border border-gray-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 print:bg-white print:border-none print:p-0 whitespace-pre-wrap"
                ></div>
            </div>

            <!-- フッター -->
            <div class="text-center text-xs text-gray-400 py-8 print:text-black">
                Generative Report Tool for Google Business Profile | <span id="footer-month"></span> Report
            </div>
        </div>

        <!-- コンテンツエリア：データ編集（初期は非表示） -->
        <div id="view-edit" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="edit-2" class="w-5 h-5"></i>
                        <span id="edit-title-month"></span> のデータ編集
                    </h2>
                    
                    <div class="flex gap-2">
                        <button onclick="handleDeleteMonth()" class="flex items-center gap-1 px-3 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
                        </button>
                        <button onclick="handleAddMonth()" class="flex items-center gap-1 px-3 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> 翌月を作成
                        </button>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg flex items-start gap-3">
                        <div class="bg-blue-100 p-2 rounded-full text-blue-600 mt-0.5">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-blue-900">自動保存機能</p>
                            <p class="text-xs text-blue-700">編集内容はブラウザに自動保存されます。</p>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ビジネス名</label>
                            <input type="text" id="input-businessName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">レポート期間表記</label>
                            <input type="text" id="input-reportPeriod" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
    
                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-4">主要指標 (手動上書き)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">総表示回数</label>
                                <input type="number" id="input-totalViews" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">表示数成長率 (%)</label>
                                <input type="number" id="input-viewsGrowth" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">総アクション数</label>
                                <input type="number" id="input-totalActions" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">平均評価</label>
                                <input type="number" step="0.1" max="5.0" id="input-averageRating" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
    
                    <!-- キーワード貼り付けエリア -->
                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-2">検索キーワード（コピペで自動解析）</h3>
                        <p class="text-xs text-gray-500 mb-3">Google管理画面の「キーワード」表をコピーして、ここに貼り付けてください。</p>
                        
                        <div class="flex gap-2 items-start">
                            <textarea id="input-keywords-paste" class="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono h-24 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="例:&#10;カフェ 150&#10;ランチ 80"></textarea>
                            <button onclick="handleKeywordPaste()" class="flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1">
                                <i data-lucide="clipboard-paste" class="w-4 h-4"></i> 解析
                            </button>
                        </div>
                        
                        <!-- 現在のキーワード表示 -->
                        <div id="edit-keyword-tags" class="mt-4 bg-gray-50 p-3 rounded-lg flex flex-wrap gap-2 min-h-[40px]">
                            <!-- JSで挿入 -->
                        </div>
                    </div>
    
                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-4">データインポート (ランダム生成)</h3>
                        <div onclick="handleDataRegenerate()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative">
                            <i data-lucide="refresh-cw" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-sm text-gray-600 font-medium">グラフデータを再生成（デモ用）</p>
                            <p class="text-xs text-gray-400 mt-1">※実際のCSVインポートはこのHTML版では模擬動作になります</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript Logic -->
    <script>
        // --- 設定・初期データ ---
        const STORAGE_KEY = 'gbp_report_html_v1';
        
        // モックデータ生成
        function generateMockData(daysInMonth = 30) {
            const days = [];
            for (let i = 1; i <= daysInMonth; i++) {
                days.push({
                    day: `${i}日`,
                    searchView: Math.floor(Math.random() * 500) + 100,
                    mapView: Math.floor(Math.random() * 800) + 200,
                    website: Math.floor(Math.random() * 50),
                    calls: Math.floor(Math.random() * 20),
                    directions: Math.floor(Math.random() * 30),
                });
            }
            return days;
        }

        const defaultReportData = {
            "2023-10": {
                config: {
                    businessName: "サンプルカフェ 東京店",
                    reportPeriod: "2023年10月1日 - 2023年10月31日",
                    totalViews: 12450,
                    viewsGrowth: 12.5,
                    totalActions: 850,
                    actionsGrowth: -2.3,
                    averageRating: 4.8,
                    reviewCount: 124,
                    comment: "・検索数は前月比+12.5%と好調に推移しました。\n・特に週末のルート検索数が増加しており、観光客の利用が増えている可能性があります。"
                },
                keywords: [
                    { word: "近くのカフェ", count: 1250 },
                    { word: "ランチ おすすめ", count: 890 },
                    { word: "Wi-Fi カフェ", count: 650 },
                    { word: "コーヒー 美味しい", count: 420 },
                    { word: "サンプルカフェ", count: 350 },
                ],
                data: generateMockData(31)
            }
        };

        // --- State Management ---
        let appState = {
            reports: {},
            currentMonthKey: "",
            activeTab: 'dashboard' // 'dashboard' or 'edit'
        };

        let charts = {}; // Chart.js instances

        // --- 初期化 ---
        function init() {
            // データ読み込み
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                appState.reports = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultReportData));
            } catch (e) {
                console.error("Load failed", e);
                appState.reports = JSON.parse(JSON.stringify(defaultReportData));
            }

            // 最新の月を選択
            const keys = Object.keys(appState.reports).sort();
            appState.currentMonthKey = keys[keys.length - 1];

            // イベントリスナー設定
            setupEventListeners();

            // 初期レンダリング
            render();
            lucide.createIcons();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.reports));
        }

        function setupEventListeners() {
            // タブ切り替え
            document.getElementById('tab-dashboard').addEventListener('click', () => {
                appState.activeTab = 'dashboard';
                render();
            });
            document.getElementById('tab-edit').addEventListener('click', () => {
                appState.activeTab = 'edit';
                render();
            });

            // 月移動
            document.getElementById('btn-prev-month').addEventListener('click', () => changeMonth('prev'));
            document.getElementById('btn-next-month').addEventListener('click', () => changeMonth('next'));

            // 入力フィールドの変更監視 (Edit画面)
            const inputs = ['businessName', 'reportPeriod', 'totalViews', 'viewsGrowth', 'totalActions', 'averageRating'];
            inputs.forEach(id => {
                document.getElementById(`input-${id}`).addEventListener('input', (e) => {
                    const currentReport = appState.reports[appState.currentMonthKey];
                    if(currentReport) {
                        currentReport.config[id] = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value;
                        saveState();
                        // 編集画面なので即座に全体再描画は不要だが、Headerなどは更新したい
                        document.getElementById('header-business-name').textContent = currentReport.config.businessName;
                    }
                });
            });

            // コメント編集 (Dashboard画面)
            document.getElementById('comment-display').addEventListener('blur', (e) => {
                const currentReport = appState.reports[appState.currentMonthKey];
                if(currentReport) {
                    currentReport.config.comment = e.target.innerText;
                    saveState();
                }
            });
        }

        function changeMonth(direction) {
            const keys = Object.keys(appState.reports).sort();
            const index = keys.indexOf(appState.currentMonthKey);
            let newIndex = direction === 'prev' ? index - 1 : index + 1;
            
            if (newIndex >= 0 && newIndex < keys.length) {
                appState.currentMonthKey = keys[newIndex];
                render();
            }
        }

        function handleAddMonth() {
            const keys = Object.keys(appState.reports).sort();
            const lastKey = keys[keys.length - 1];
            const [year, month] = lastKey.split('-').map(Number);
            
            let nextYear = year;
            let nextMonth = month + 1;
            if (nextMonth > 12) { nextMonth = 1; nextYear++; }
            
            const nextKey = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
            
            if (appState.reports[nextKey]) {
                alert("既にデータが存在します");
                appState.currentMonthKey = nextKey;
                render();
                return;
            }

            // データコピー作成
            const prevConfig = appState.reports[lastKey].config;
            appState.reports[nextKey] = {
                config: {
                    ...prevConfig,
                    reportPeriod: `${nextYear}年${nextMonth}月1日 - ${nextYear}年${nextMonth}月末日`,
                    totalViews: 0,
                    viewsGrowth: 0,
                    totalActions: 0,
                    comment: "今月の総括..."
                },
                keywords: [],
                data: generateMockData(30)
            };
            
            appState.currentMonthKey = nextKey;
            appState.activeTab = 'edit';
            saveState();
            render();
        }

        function handleDeleteMonth() {
            const keys = Object.keys(appState.reports);
            if(keys.length <= 1) { alert("削除できません"); return; }
            if(!confirm("削除しますか？")) return;

            delete appState.reports[appState.currentMonthKey];
            const newKeys = Object.keys(appState.reports).sort();
            appState.currentMonthKey = newKeys[newKeys.length - 1];
            saveState();
            render();
        }

        function handleDataRegenerate() {
            if(!confirm("現在の月のグラフデータをランダムに再生成しますか？")) return;
            appState.reports[appState.currentMonthKey].data = generateMockData(30);
            saveState();
            alert("データを更新しました。レポートタブで確認してください。");
        }

        function handleKeywordPaste() {
            const text = document.getElementById('input-keywords-paste').value;
            if (!text) return;

            // 簡易パーサーロジック (React版と同じロジックを移植)
            const lines = text.split(/\n/).map(l => l.trim()).filter(l => l);
            const newKeywords = [];
            const oneLineRegex = /^(.+?)[\s\t]+(\d{1,3}(?:,\d{3})*|\d+)$/;

            let isMultiLine = true;
            for (let line of lines) {
                if (oneLineRegex.test(line)) { isMultiLine = false; break; }
            }

            if (!isMultiLine) {
                lines.forEach(line => {
                    const match = line.match(oneLineRegex);
                    if (match) newKeywords.push({ word: match[1].trim(), count: parseInt(match[2].replace(/,/g, ''), 10) });
                });
            } else {
                for (let i = 0; i < lines.length - 1; i++) {
                    const current = lines[i];
                    const next = lines[i + 1];
                    if (isNaN(parseInt(current.replace(/,/g, ''))) && !isNaN(parseInt(next.replace(/,/g, '')))) {
                        newKeywords.push({ word: current, count: parseInt(next.replace(/,/g, ''), 10) });
                        i++;
                    }
                }
            }

            const sorted = newKeywords.sort((a, b) => b.count - a.count).slice(0, 5);
            if(sorted.length > 0) {
                appState.reports[appState.currentMonthKey].keywords = sorted;
                saveState();
                document.getElementById('input-keywords-paste').value = "";
                renderEditKeywords(); // キーワードタグ表示更新
                alert(`${sorted.length}件のキーワードを抽出しました`);
            } else {
                alert("解析できませんでした");
            }
        }

        // --- レンダリング ---
        function render() {
            const report = appState.reports[appState.currentMonthKey];
            if (!report) return;

            // ヘッダー情報
            document.getElementById('header-business-name').textContent = report.config.businessName;
            document.getElementById('current-month-display').textContent = appState.currentMonthKey;
            document.getElementById('report-period-badge').textContent = `対象期間: ${report.config.reportPeriod}`;
            document.getElementById('footer-month').textContent = appState.currentMonthKey;

            // タブ表示切り替え
            const tabDash = document.getElementById('tab-dashboard');
            const tabEdit = document.getElementById('tab-edit');
            const viewDash = document.getElementById('view-dashboard');
            const viewEdit = document.getElementById('view-edit');

            if (appState.activeTab === 'dashboard') {
                tabDash.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center bg-white shadow text-blue-600";
                tabEdit.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center text-gray-600 hover:bg-gray-200";
                viewDash.classList.remove('hidden');
                viewEdit.classList.add('hidden');
                
                renderDashboard(report);
            } else {
                tabEdit.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center bg-white shadow text-blue-600";
                tabDash.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center text-gray-600 hover:bg-gray-200";
                viewDash.classList.add('hidden');
                viewEdit.classList.remove('hidden');

                renderEditForm(report);
            }
            
            // 月移動ボタンの状態
            const keys = Object.keys(appState.reports).sort();
            document.getElementById('btn-prev-month').disabled = keys.indexOf(appState.currentMonthKey) === 0;
            document.getElementById('btn-next-month').disabled = keys.indexOf(appState.currentMonthKey) === keys.length - 1;

            lucide.createIcons();
        }

        function renderDashboard(report) {
            // KPI
            document.getElementById('kpi-total-views').textContent = Number(report.config.totalViews).toLocaleString();
            document.getElementById('kpi-total-actions').textContent = Number(report.config.totalActions).toLocaleString();
            document.getElementById('kpi-rating').textContent = report.config.averageRating;
            document.getElementById('kpi-review-count').textContent = `全レビュー数: ${report.config.reviewCount}`;
            document.getElementById('kpi-photo-views').textContent = Math.round(report.config.totalViews * 1.5).toLocaleString();
            document.getElementById('comment-display').innerText = report.config.comment;

            // 成長率表示 (正負で色変え)
            const renderGrowth = (elId, val) => {
                const el = document.getElementById(elId);
                const isPos = val >= 0;
                el.className = `flex items-center text-xs font-medium ${isPos ? 'text-green-600' : 'text-red-600'}`;
                el.innerHTML = `<i data-lucide="${isPos ? 'trending-up' : 'trending-down'}" class="w-3 h-3 mr-1"></i> ${Math.abs(val)}% <span class="text-gray-400 ml-1 font-normal">前月比</span>`;
            };
            renderGrowth('kpi-views-growth', report.config.viewsGrowth);
            renderGrowth('kpi-actions-growth', report.config.actionsGrowth);

            // キーワードリスト
            const kwContainer = document.getElementById('keyword-list-container');
            kwContainer.innerHTML = '';
            if (report.keywords && report.keywords.length > 0) {
                const maxVal = Math.max(...report.keywords.map(k => k.count));
                report.keywords.forEach(k => {
                    const width = (k.count / maxVal) * 100;
                    kwContainer.innerHTML += `
                        <div class="flex items-center justify-between group">
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-700">${k.word}</span>
                                    <span class="text-sm text-gray-500">${k.count}回</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${width}%"></div>
                                </div>
                            </div>
                        </div>`;
                });
            } else {
                kwContainer.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm border-2 border-dashed border-gray-100 rounded-lg">データなし</div>';
            }

            // チャート描画 (Chart.js)
            drawCharts(report.data);
        }

        function drawCharts(data) {
            // Chart 1: Area (Line)
            const ctxViews = document.getElementById('chart-views').getContext('2d');
            if(charts.views) charts.views.destroy();

            charts.views = new Chart(ctxViews, {
                type: 'line',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [
                        {
                            label: '検索経由',
                            data: data.map(d => d.searchView),
                            borderColor: '#4285F4',
                            backgroundColor: 'rgba(66, 133, 244, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'マップ経由',
                            data: data.map(d => d.mapView),
                            borderColor: '#EA4335',
                            backgroundColor: 'rgba(234, 67, 53, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Chart 2: Bar
            const ctxActions = document.getElementById('chart-actions').getContext('2d');
            if(charts.actions) charts.actions.destroy();

            charts.actions = new Chart(ctxActions, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day).filter((_, i) => i % 5 === 0), // 間引き
                    datasets: [
                        { label: 'ウェブサイト', data: data.map(d => d.website).filter((_, i) => i % 5 === 0), backgroundColor: '#4285F4' },
                        { label: '通話', data: data.map(d => d.calls).filter((_, i) => i % 5 === 0), backgroundColor: '#34A853' },
                        { label: 'ルート検索', data: data.map(d => d.directions).filter((_, i) => i % 5 === 0), backgroundColor: '#FBBC04' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        }

        function renderEditForm(report) {
            document.getElementById('edit-title-month').textContent = appState.currentMonthKey;
            
            // 値のセット
            const setVal = (id, val) => document.getElementById(`input-${id}`).value = val;
            setVal('businessName', report.config.businessName);
            setVal('reportPeriod', report.config.reportPeriod);
            setVal('totalViews', report.config.totalViews);
            setVal('viewsGrowth', report.config.viewsGrowth);
            setVal('totalActions', report.config.totalActions);
            setVal('averageRating', report.config.averageRating);

            renderEditKeywords();
        }

        function renderEditKeywords() {
            const report = appState.reports[appState.currentMonthKey];
            const container = document.getElementById('edit-keyword-tags');
            container.innerHTML = '';
            if (report.keywords) {
                report.keywords.forEach(k => {
                    container.innerHTML += `<span class="bg-white border border-gray-200 px-2 py-1 rounded text-xs text-gray-700">${k.word}: ${k.count}</span>`;
                });
            }
        }

        // スタート
        init();
    </script>
</body>
</html>
