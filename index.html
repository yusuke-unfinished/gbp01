<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleビジネスプロフィール レポートツール</title>
    <!-- Tailwind CSS (スタイリング用) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (グラフ描画用) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons (アイコン用) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-break-inside-avoid { break-inside: avoid; }
            .print-shadow-none { box-shadow: none !important; }
            .print-border-none { border: none !important; }
            .print-full-width { width: 100% !important; max-width: none !important; }
            canvas { max-height: 100% !important; }
        }
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <!-- ヘッダー -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10 print:static print:shadow-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg no-print">
                    <i data-lucide="map-pin" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 id="header-business-name" class="text-xl font-bold text-gray-900">店舗名読み込み中...</h1>
                    <p class="text-xs text-gray-500">Googleビジネスプロフィール レポート</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 no-print">
                <div class="flex items-center bg-gray-100 rounded-lg p-1 mr-4">
                    <button id="btn-prev-month" class="p-1.5 hover:bg-white rounded-md disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <span id="current-month-display" class="mx-3 font-bold text-sm min-w-[80px] text-center">---</span>
                    <button id="btn-next-month" class="p-1.5 hover:bg-white rounded-md disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="hidden md:flex bg-gray-100 rounded-lg p-1">
                    <button id="tab-dashboard" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center bg-white shadow text-blue-600">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> レポート
                    </button>
                    <button id="tab-edit" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center text-gray-600 hover:bg-gray-200">
                        <i data-lucide="edit-2" class="w-4 h-4 mr-1"></i> データ編集
                    </button>
                </div>
                
                <button onclick="window.print()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">印刷</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 print:py-0 print:px-0 print:w-full print-full-width">
        
        <div class="mb-8 print:mb-4 text-center print:text-left">
            <span id="report-period-badge" class="inline-block bg-white border border-gray-200 rounded-full px-4 py-1 text-sm text-gray-600 shadow-sm print:border-none print:shadow-none print:px-0 print:font-bold">
                対象期間: ---
            </span>
        </div>

        <!-- コンテンツエリア：ダッシュボード -->
        <div id="view-dashboard" class="space-y-8 print:space-y-6">
            
            <!-- KPI カード -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 print:grid-cols-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">総表示回数 (閲覧数)</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="search" class="w-5 h-5 text-blue-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-total-views" class="text-2xl font-bold text-gray-900">0</h3>
                    </div>
                    <div id="kpi-views-growth" class="flex items-center text-xs font-medium"></div>
                    <p class="text-xs text-gray-400 mt-2">検索 + マップ (モバイル/PC合算)</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">アクション数合計</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="mouse-pointer" class="w-5 h-5 text-green-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-total-actions" class="text-2xl font-bold text-gray-900">0</h3>
                    </div>
                    <div id="kpi-actions-growth" class="flex items-center text-xs font-medium"></div>
                    <p class="text-xs text-gray-400 mt-2">ウェブ・通話・ルート・注文他</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">平均評価</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="star" class="w-5 h-5 text-yellow-500"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-rating" class="text-2xl font-bold text-gray-900">0.0</h3>
                        <span class="text-yellow-500 text-lg">★</span>
                    </div>
                    <p id="kpi-review-count" class="text-xs text-gray-400 mt-2">全レビュー数: ---</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 print:border print:shadow-none">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-sm font-medium text-gray-500">モバイル利用率</p>
                        <div class="p-2 bg-gray-50 rounded-lg no-print"><i data-lucide="smartphone" class="w-5 h-5 text-purple-600"></i></div>
                    </div>
                    <div class="flex items-end gap-2 mb-1">
                        <h3 id="kpi-mobile-rate" class="text-2xl font-bold text-gray-900">0</h3>
                        <span class="text-gray-500 text-lg">%</span>
                    </div>
                    <div class="flex items-center text-xs font-medium text-gray-400">
                        全閲覧数に占めるモバイルの割合
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 print:grid-cols-2">
                <!-- デバイス別閲覧数 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                    <div class="mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-gray-500"></i>
                            プラットフォーム別 閲覧内訳
                        </h2>
                        <p class="text-sm text-gray-500">モバイルとパソコンの利用比率</p>
                    </div>
                    <div class="relative w-full h-64">
                        <canvas id="chart-devices"></canvas>
                    </div>
                </div>

                <!-- アクション内訳 -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                    <div class="mb-4">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="mouse-pointer" class="w-5 h-5 text-gray-500"></i>
                            アクションの詳細
                        </h2>
                        <p class="text-sm text-gray-500">ユーザーが実行した具体的な行動</p>
                    </div>
                    <div class="relative w-full h-64">
                        <canvas id="chart-actions-details"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                <div class="mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i>
                        主な検索キーワード
                    </h2>
                    <p class="text-sm text-gray-500">管理画面からコピペして追加してください</p>
                </div>
                <div id="keyword-list-container" class="space-y-4"></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 print:shadow-none print:border print:break-inside-avoid">
                <h2 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-5 h-5 text-gray-500"></i>
                    今月の総括と改善提案
                </h2>
                <div id="comment-display" contenteditable="true" class="w-full min-h-[100px] p-4 border border-gray-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 print:bg-white print:border-none print:p-0 whitespace-pre-wrap"></div>
            </div>

            <div class="text-center text-xs text-gray-400 py-8 print:text-black">
                Generative Report Tool for Google Business Profile | <span id="footer-month"></span> Report
            </div>
        </div>

        <!-- コンテンツエリア：データ編集 -->
        <div id="view-edit" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-3xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="edit-2" class="w-5 h-5"></i>
                        <span id="edit-title-month"></span> のデータ編集
                    </h2>
                    
                    <div class="flex gap-2">
                        <button onclick="handleDeleteMonth()" class="flex items-center gap-1 px-3 py-2 text-sm text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
                        </button>
                        <button onclick="handleAddMonth()" class="flex items-center gap-1 px-3 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm">
                            <i data-lucide="plus" class="w-4 h-4"></i> 翌月を作成
                        </button>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg flex items-start gap-3">
                        <div class="bg-blue-100 p-2 rounded-full text-blue-600 mt-0.5">
                            <i data-lucide="upload" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-blue-900">CSVインポート対応済み</p>
                            <p class="text-xs text-blue-700">「GMB insights」形式のCSVファイルを読み込むと、店舗名や数値を自動抽出します。</p>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ビジネス名</label>
                            <input type="text" id="input-businessName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">レポート期間表記</label>
                            <input type="text" id="input-reportPeriod" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
    
                    <!-- CSVインポート -->
                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-4">パフォーマンスレポート(CSV)をインポート</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors relative">
                            <input type="file" id="csv-file-input" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <i data-lucide="file-spreadsheet" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                            <p class="text-sm text-gray-600 font-medium">CSVファイルをアップロード</p>
                            <p class="text-xs text-gray-400 mt-1">店舗概要のパフォーマンスCSVを読み込みます</p>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-4">主要指標 (手動微調整用)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">総閲覧数</label>
                                <input type="number" id="input-totalViews" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">前月比成長率 (%)</label>
                                <input type="number" id="input-viewsGrowth" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">アクション数</label>
                                <input type="number" id="input-totalActions" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">平均評価</label>
                                <input type="number" step="0.1" max="5.0" id="input-averageRating" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
    
                    <div class="border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-bold text-gray-900 mb-2">検索キーワードの追加</h3>
                        <div class="flex gap-2 items-start">
                            <textarea id="input-keywords-paste" class="w-full p-3 border border-gray-300 rounded-lg text-sm font-mono h-24 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="キーワード 100"></textarea>
                            <button onclick="handleKeywordPaste()" class="flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-1">
                                <i data-lucide="plus" class="w-4 h-4"></i> 解析
                            </button>
                        </div>
                        <div id="edit-keyword-tags" class="mt-4 bg-gray-50 p-3 rounded-lg flex flex-wrap gap-2 min-h-[40px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const STORAGE_KEY = 'gbp_report_html_v3';
        
        const defaultReportData = {
            "2025-12": {
                config: {
                    businessName: "オーシマドーナツ 京都祇園店",
                    reportPeriod: "2025年12月1日 - 2025年12月31日",
                    totalViews: 4187,
                    viewsGrowth: 0,
                    totalActions: 575,
                    actionsGrowth: 0,
                    averageRating: 4.5,
                    reviewCount: 88,
                    comment: "CSVインポートでデータが反映されます。"
                },
                keywords: [],
                // デバイス内訳とアクション内訳を保持
                breakdown: {
                    mobileSearch: 1615, desktopSearch: 180,
                    mobileMap: 2336, desktopMap: 56,
                    calls: 11, website: 201, directions: 185, menu: 178, orders: 0, messages: 0, bookings: 0
                }
            }
        };

        let appState = {
            reports: {},
            currentMonthKey: "",
            activeTab: 'dashboard'
        };

        let charts = {};

        function init() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                appState.reports = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultReportData));
            } catch (e) {
                appState.reports = JSON.parse(JSON.stringify(defaultReportData));
            }

            const keys = Object.keys(appState.reports).sort();
            appState.currentMonthKey = keys[keys.length - 1] || "2025-12";

            setupEventListeners();
            render();
            lucide.createIcons();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.reports));
        }

        function setupEventListeners() {
            document.getElementById('tab-dashboard').addEventListener('click', () => { appState.activeTab = 'dashboard'; render(); });
            document.getElementById('tab-edit').addEventListener('click', () => { appState.activeTab = 'edit'; render(); });
            document.getElementById('btn-prev-month').addEventListener('click', () => changeMonth('prev'));
            document.getElementById('btn-next-month').addEventListener('click', () => changeMonth('next'));

            const inputs = ['businessName', 'reportPeriod', 'totalViews', 'viewsGrowth', 'totalActions', 'averageRating'];
            inputs.forEach(id => {
                document.getElementById(`input-${id}`).addEventListener('input', (e) => {
                    const currentReport = appState.reports[appState.currentMonthKey];
                    if(currentReport) {
                        currentReport.config[id] = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
                        saveState();
                        document.getElementById('header-business-name').textContent = currentReport.config.businessName;
                    }
                });
            });

            document.getElementById('comment-display').addEventListener('blur', (e) => {
                const currentReport = appState.reports[appState.currentMonthKey];
                if(currentReport) { currentReport.config.comment = e.target.innerText; saveState(); }
            });

            document.getElementById('csv-file-input').addEventListener('change', handleCsvImport);
        }

        function handleCsvImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const csvData = event.target.result;
                parseAndApplyCsv(csvData);
            };
            reader.readAsText(file);
        }

        function parseAndApplyCsv(csvText) {
            // GoogleのCSVはダブルクォーテーションで囲まれていることが多いため、単純なsplitではなく考慮する
            const rows = csvText.split(/\r?\n/).map(row => {
                const matches = row.match(/(".*?"|[^,]+|(?<=,)(?=,)|(?<=^)(?=,)|(?<=,)(?=$))/g);
                return matches ? matches.map(m => m.replace(/^"|"$/g, '').trim()) : [];
            });

            if (rows.length < 3) return alert("CSV形式が正しくありません。");

            // ヘッダー行(1行目)を元にインデックスを特定
            const headers = rows[0];
            const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h === k));

            const idxName = findIdx(['ビジネス名', 'Business name']);
            const idxSearchMobile = findIdx(['Google 検索 - モバイル', 'Google Search - Mobile']);
            const idxSearchDesktop = findIdx(['Google 検索 - パソコン', 'Google Search - Desktop']);
            const idxMapMobile = findIdx(['Google マップ - モバイル', 'Google Maps - Mobile']);
            const idxMapDesktop = findIdx(['Google マップ - パソコン', 'Google Maps - Desktop']);
            
            const idxCall = findIdx(['通話', 'Phone calls']);
            const idxMsg = findIdx(['メッセージ', 'Messages']);
            const idxBook = findIdx(['予約', 'Bookings']);
            const idxDir = findIdx(['ルート', 'Direction requests']);
            const idxWeb = findIdx(['ウェブサイトのクリック', 'Website clicks']);
            const idxOrder = findIdx(['料理の注文', 'Food orders']);
            const idxMenu = findIdx(['フードメニューのクリック', 'Food menu clicks']);

            // 3行目からがデータ（2行目は説明文）
            const dataRow = rows[2];
            if (!dataRow || dataRow.length < headers.length) return alert("データ行が見つかりません。");

            const getVal = (idx) => parseInt(dataRow[idx]) || 0;

            const breakdown = {
                mobileSearch: getVal(idxSearchMobile),
                desktopSearch: getVal(idxSearchDesktop),
                mobileMap: getVal(idxMapMobile),
                desktopMap: getVal(idxMapDesktop),
                calls: getVal(idxCall),
                messages: getVal(idxMsg),
                bookings: getVal(idxBook),
                directions: getVal(idxDir),
                website: getVal(idxWeb),
                orders: getVal(idxOrder),
                menu: getVal(idxMenu)
            };

            const totalViews = breakdown.mobileSearch + breakdown.desktopSearch + breakdown.mobileMap + breakdown.desktopMap;
            const totalActions = breakdown.calls + breakdown.messages + breakdown.bookings + breakdown.directions + breakdown.website + breakdown.orders + breakdown.menu;

            const report = appState.reports[appState.currentMonthKey];
            report.config.businessName = dataRow[idxName] || report.config.businessName;
            report.config.totalViews = totalViews;
            report.config.totalActions = totalActions;
            report.breakdown = breakdown;

            saveState();
            alert(`インポート成功！\n店舗名: ${report.config.businessName}\n総閲覧数: ${totalViews.toLocaleString()}`);
            render();
        }

        function changeMonth(direction) {
            const keys = Object.keys(appState.reports).sort();
            const index = keys.indexOf(appState.currentMonthKey);
            let newIndex = direction === 'prev' ? index - 1 : index + 1;
            if (newIndex >= 0 && newIndex < keys.length) { appState.currentMonthKey = keys[newIndex]; render(); }
        }

        function handleAddMonth() {
            const keys = Object.keys(appState.reports).sort();
            const lastKey = keys[keys.length - 1];
            const [year, month] = lastKey.split('-').map(Number);
            let nextMonth = month + 1; let nextYear = year;
            if (nextMonth > 12) { nextMonth = 1; nextYear++; }
            const nextKey = `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
            if (appState.reports[nextKey]) { alert("既に存在します"); return; }

            appState.reports[nextKey] = {
                config: { ...appState.reports[lastKey].config, totalViews: 0, totalActions: 0, comment: "" },
                keywords: [],
                breakdown: { ...appState.reports[lastKey].breakdown }
            };
            appState.currentMonthKey = nextKey;
            appState.activeTab = 'edit';
            saveState();
            render();
        }

        function handleDeleteMonth() {
            if(Object.keys(appState.reports).length <= 1) return alert("削除不可");
            if(!confirm("削除しますか？")) return;
            delete appState.reports[appState.currentMonthKey];
            appState.currentMonthKey = Object.keys(appState.reports).sort().pop();
            saveState();
            render();
        }

        function handleKeywordPaste() {
            const text = document.getElementById('input-keywords-paste').value;
            if (!text) return;
            const lines = text.split(/\n/).map(l => l.trim()).filter(l => l);
            const newKeywords = [];
            lines.forEach(line => {
                const parts = line.split(/[\s\t]+/);
                if (parts.length >= 2) {
                    const count = parseInt(parts.pop().replace(/,/g, ''));
                    if (!isNaN(count)) newKeywords.push({ word: parts.join(' '), count: count });
                }
            });
            const sorted = newKeywords.sort((a,b) => b.count - a.count).slice(0, 5);
            if(sorted.length > 0) {
                appState.reports[appState.currentMonthKey].keywords = sorted;
                saveState();
                document.getElementById('input-keywords-paste').value = "";
                renderEditKeywords();
                render();
            }
        }

        function render() {
            const report = appState.reports[appState.currentMonthKey];
            if (!report) return;

            document.getElementById('header-business-name').textContent = report.config.businessName;
            document.getElementById('current-month-display').textContent = appState.currentMonthKey;
            document.getElementById('report-period-badge').textContent = `対象期間: ${report.config.reportPeriod}`;
            document.getElementById('footer-month').textContent = appState.currentMonthKey;

            const viewDash = document.getElementById('view-dashboard');
            const viewEdit = document.getElementById('view-edit');

            if (appState.activeTab === 'dashboard') {
                viewDash.classList.remove('hidden'); viewEdit.classList.add('hidden');
                renderDashboard(report);
            } else {
                viewDash.classList.add('hidden'); viewEdit.classList.remove('hidden');
                renderEditForm(report);
            }
            lucide.createIcons();
        }

        function renderDashboard(report) {
            document.getElementById('kpi-total-views').textContent = Number(report.config.totalViews).toLocaleString();
            document.getElementById('kpi-total-actions').textContent = Number(report.config.totalActions).toLocaleString();
            document.getElementById('kpi-rating').textContent = report.config.averageRating;
            document.getElementById('comment-display').innerText = report.config.comment;

            const b = report.breakdown || {};
            const totalV = report.config.totalViews || 1;
            const mobileRate = Math.round(((b.mobileSearch + b.mobileMap) / totalV) * 100);
            document.getElementById('kpi-mobile-rate').textContent = mobileRate;

            const renderGr = (elId, val) => {
                const el = document.getElementById(elId); const isP = val >= 0;
                el.className = `flex items-center text-xs font-medium ${isP ? 'text-green-600' : 'text-red-600'}`;
                el.innerHTML = `<i data-lucide="${isP ? 'trending-up' : 'trending-down'}" class="w-3 h-3 mr-1"></i> ${Math.abs(val)}% <span class="text-gray-400 ml-1 font-normal">前月比</span>`;
            };
            renderGr('kpi-views-growth', report.config.viewsGrowth);
            renderGr('kpi-actions-growth', report.config.actionsGrowth);

            const kwContainer = document.getElementById('keyword-list-container');
            kwContainer.innerHTML = report.keywords.length > 0 ? report.keywords.map(k => {
                const max = Math.max(...report.keywords.map(kw => kw.count));
                return `<div class="flex items-center justify-between group"><div class="flex-1"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">${k.word}</span><span class="text-sm text-gray-500">${k.count.toLocaleString()}回</span></div><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${(k.count/max)*100}%"></div></div></div></div>`;
            }).join('') : '<div class="text-center py-8 text-gray-400 text-sm border border-dashed rounded-lg">「データ編集」からキーワードを追加してください</div>';

            drawCharts(report);
        }

        function drawCharts(report) {
            const b = report.breakdown || {};
            
            // Chart 1: Device Breakdown (Doughnut)
            const ctxD = document.getElementById('chart-devices').getContext('2d');
            if(charts.devices) charts.devices.destroy();
            charts.devices = new Chart(ctxD, {
                type: 'doughnut',
                data: {
                    labels: ['モバイル検索', 'デスクトップ検索', 'モバイルマップ', 'デスクトップマップ'],
                    datasets: [{
                        data: [b.mobileSearch, b.desktopSearch, b.mobileMap, b.desktopMap],
                        backgroundColor: ['#4285F4', '#93BAFB', '#EA4335', '#F5A29B']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            // Chart 2: Action Breakdown (Horizontal Bar)
            const ctxA = document.getElementById('chart-actions-details').getContext('2d');
            if(charts.actions) charts.actions.destroy();
            charts.actions = new Chart(ctxA, {
                type: 'bar',
                data: {
                    labels: ['ウェブサイト', 'ルート', 'メニュー', '通話', 'メッセージ', '予約', '注文'],
                    datasets: [{
                        label: 'アクション回数',
                        data: [b.website, b.directions, b.menu, b.calls, b.messages, b.bookings, b.orders],
                        backgroundColor: '#34A853'
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderEditForm(report) {
            document.getElementById('edit-title-month').textContent = appState.currentMonthKey;
            const setVal = (id, val) => document.getElementById(`input-${id}`).value = val;
            setVal('businessName', report.config.businessName);
            setVal('reportPeriod', report.config.reportPeriod);
            setVal('totalViews', report.config.totalViews);
            setVal('viewsGrowth', report.config.viewsGrowth);
            setVal('totalActions', report.config.totalActions);
            setVal('averageRating', report.config.averageRating);
            renderEditKeywords();
        }

        function renderEditKeywords() {
            const r = appState.reports[appState.currentMonthKey];
            document.getElementById('edit-keyword-tags').innerHTML = r.keywords.map(k => `<span class="bg-white border border-gray-200 px-2 py-1 rounded text-xs text-gray-700">${k.word}: ${k.count}</span>`).join('');
        }

        init();
    </script>
</body>
</html>
